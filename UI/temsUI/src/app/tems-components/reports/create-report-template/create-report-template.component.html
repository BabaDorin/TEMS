<div class="card">
  <div class="card-body">
    <div class="card-title">Create new report template</div>
    <hr class="mb-2">
    <form [formGroup]="reportFormGroup">
      <p class="text-muted">
        If you want to save this template, provide a name and a description if necessary
      </p>
      
      <mat-form-field class="reportFormControl mb-2 d-block">
        <mat-label>Name</mat-label>
        <input matInput formControlName="name">
      </mat-form-field>

      <mat-form-field class="reportFormControl mb-2">
        <mat-label>Description</mat-label>
        <textarea matInput formControlName="description"></textarea>
      </mat-form-field>
      <hr class="mt-3 mb-3">

      <mat-vertical-stepper>
        <!-- STEP 1- Subject choice -->
        <mat-step>
          <ng-template matStepLabel>Choose the subject</ng-template>
          <p class="text-muted">
            Choose the type of entities that will be present in the report. 
          </p>
          <mat-form-field class="reportFormControl">
            <mat-label>Choose the report's subject</mat-label>
            <mat-select formControlName="subject">
              <mat-option *ngFor="let option of reportObjectOptions" [value]="option.value">
                {{ option.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <button mat-button class="d-block" matStepperNext>Next</button>
        </mat-step>

        <!-- STEP 2 - Layout configuration (For equipment: Types, definitions, personnel, room, SeparateBy) -->
        <mat-step>
          <ng-template matStepLabel>Layout configuration</ng-template>
          <p class="text-muted">
            Configure the way how TEMS should generate the report.
          </p>
          <ng-container *ngIf="reportFormGroup.controls.subject.value != 'equipment'">
            <p class="text-muted">
              Please, select a supported subject first.
            </p>
          </ng-container>
          <ng-container *ngIf="reportFormGroup.controls.subject.value == 'equipment'">
            <div class="row">
              <div class="col-md-5">
                <app-chips-autocomplete label="Equipment types" formControlName="types"
                  placeholder="No selection = all types" 
                  [alreadySelected]="typesAlreadySelected"s
                  [endPoint]="typeService"
                  (dataCollected)="typeAdded($event)"
                  (dataRemoved)="typeRemoved($event)">
                </app-chips-autocomplete>
              </div>
              <div class="col-md-5">
                <app-chips-autocomplete label="Definitions for selected types" formControlName="definitions"
                  placeholder="No selection = all definitions" 
                  [endPoint]="definitionService"
                  [endPointParameter]="typesEndPointParameter"
                  [alreadySelected]="definitionsAlreadySelected">
                </app-chips-autocomplete>
              </div>
            </div>
            <br>
            <div class="row">
              <div class="col-md-5">
                <app-chips-autocomplete label="Include only equipment from these rooms" formControlName="rooms"
                  placeholder="No selection = all of the rooms"
                  [endPoint]="roomService" 
                  [alreadySelected]="roomsAlreadySelected">
                </app-chips-autocomplete>
              </div>
              <div class="col-md-5">
                <app-chips-autocomplete label="Include only equipment allocated to these people"
                  formControlName="personnel" placeholder="No selection = all personnel"
                  [endPoint]="personnelService"
                  [alreadySelected]="personnelAlreadySelected">
                </app-chips-autocomplete>
              </div>
            </div>
            <br>
            <mat-label>Sepparate by:</mat-label><br><br>
            
            <mat-radio-group formControlName="separateBy">
              <mat-radio-button value="none">No separation</mat-radio-button><br>
              <mat-radio-button value="room">By Room</mat-radio-button><br>
              <mat-radio-button value="personnel">By Personnel</mat-radio-button><br>
              <mat-radio-button value="type">By Type</mat-radio-button><br>
              <mat-radio-button value="definition">By Definition</mat-radio-button><br>
            </mat-radio-group>
          </ng-container>
          <button mat-button matStepperNext>Next</button>
        </mat-step>

        <!-- STEP - Select report properties -->
        <mat-step>
          <ng-template matStepLabel>Choose report columns</ng-template>

          <!-- No subject selected -->
          <ng-container *ngIf="reportFormGroup.controls.subject.value != 'equipment'">
            <p class="text-muted">Please, select a supported subject first.</p>
          </ng-container>

          <!-- Equipment subject -->
          <ng-container *ngIf="reportFormGroup.controls.subject.value == 'equipment'">
            <!-- Common properties for all equipment records -->
            <app-checkbox-group [options]="equipmentCommonProperties" label="Common proprerties for all types"
            (toggle)="onCommonPropChange($event)">
            </app-checkbox-group>

            <!-- Type specific properties -->
            <ng-container *ngFor="let type of typeSpecificProperties">
            <div class="mt-2">
              <app-checkbox-group [options]="type.properties" label="Specific properties of {{ type.type.label }}"
              (toggle)="onSpecificPropChange($event, type.type)">
              </app-checkbox-group>
            </div>
            </ng-container>
          </ng-container>
          <button mat-button matStepperNext>Next</button>
        </mat-step>

        <mat-step>
          <ng-template matStepLabel>Additional report data</ng-template>
          <br>
          <mat-form-field class="reportFormControl d-block">
            <mat-label>Header</mat-label>
            <textarea matInput formControlName="header"></textarea>
          </mat-form-field>
          <mat-form-field class="reportFormControl d-block">
            <mat-label>Footer</mat-label>
            <textarea matInput formControlName="footer"></textarea>
          </mat-form-field>
          <!-- signatories   -->
          <app-chips-autocomplete
          class="reportFormControl d-block"
          label="Signatories"
          formControlName="signatories"
          [alreadySelected]="signatoriesAlreadySelected"
          [endPoint]="personnelService"
          onlyValuesFromAutocomplete="true">
          </app-chips-autocomplete>
        </mat-step>
      </mat-vertical-stepper>
      <button mat-button (click)="save()" class="d-block">
        <mat-icon class="text-primary">save</mat-icon>
        Save template
      </button>
      <button mat-button (click)="generateReport()" class="d-block">
        <mat-icon class="text-primary">print</mat-icon>
        Generate report
      </button>
    </form>

  </div>
</div>