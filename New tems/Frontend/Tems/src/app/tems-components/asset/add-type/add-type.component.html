<div class="w-full max-w-4xl min-w-[360px] md:min-w-[720px] mx-auto" [ngClass]="dialogRef ? '' : 'py-8 px-4'">
  <div class="relative bg-white rounded-2xl shadow-xl overflow-visible">
    <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <div>
          <h2 class="text-xl font-semibold text-gray-900 m-0">{{ updateTypeId ? 'Update Type' : 'Add New Type' }}</h2>
        </div>
        <button *ngIf="dialogRef" type="button" (click)="dialogRef.close()" aria-label="Close"
          class="w-9 h-9 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition shadow-sm">
          <span class="text-lg leading-none">×</span>
        </button>
      </div>

      <form [formGroup]="formGroup" (ngSubmit)="onSubmit()" class="px-6 py-6 space-y-6 overflow-visible">
        <div class="space-y-3">
          <label class="block text-sm font-medium text-gray-800">Type name *</label>
          <input formControlName="name" type="text" placeholder="Laptop" maxlength="100"
            class="w-full rounded-xl border border-gray-200 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#007aff] focus:border-[#007aff]"
            [class.border-red-400]="formGroup.get('name')?.invalid && formGroup.get('name')?.touched">
        </div>

        <div class="space-y-3">
          <label class="block text-sm font-medium text-gray-800">Description</label>
          <textarea formControlName="description" rows="2" placeholder="Optional description"
            class="w-full rounded-xl border border-gray-200 px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#007aff] focus:border-[#007aff]"></textarea>
        </div>

        <div class="space-y-3">
          <label class="block text-sm font-medium text-gray-800">Parent type (optional)</label>
          <app-custom-select 
            formControlName="parentTypeId"
            [options]="parentTypeOptions"
            placeholder="Select parent type"
            [allowEmpty]="true"
            emptyLabel="None">
          </app-custom-select>
        </div>

        <div class="space-y-3">
          <div>
            <p class="text-sm font-medium text-gray-800 m-0">Properties</p>
            <p class="text-xs text-gray-500 m-0">Pick properties and mark required. Order follows the sequence you add them.</p>
          </div>

          <div *ngIf="propertyRows.length === 0" class="text-center py-3">
            <p class="text-sm font-medium text-gray-800 m-0">No properties yet</p>
            <p class="text-sm text-gray-500 m-0 mt-1">Add properties to this type to capture specific attributes.</p>
          </div>

          <div class="space-y-4" *ngIf="propertyRows.length > 0">
            <div *ngFor="let group of propertyRowGroups; let i = index; trackBy: trackByIndex" [formGroup]="group"
              class="relative border border-gray-100 rounded-2xl p-4 bg-white shadow-[0_6px_18px_rgba(0,0,0,0.05)]">
              <button type="button" (click)="removePropertyRow(i)" aria-label="Remove"
                class="absolute top-3 right-3 inline-flex items-center justify-center w-7 h-7 rounded-full bg-white border border-gray-200 text-gray-500 hover:text-red-500 hover:border-red-300 shadow-sm transition text-lg">
                ×
              </button>
              <div class="pr-10">
                <div class="flex items-center justify-between mb-2">
                  <label class="text-xs text-gray-600">Property</label>
                  <span class="text-xs text-gray-600">Required</span>
                </div>
                <div class="flex items-center gap-4">
                  <div class="flex-1">
                    <app-custom-select 
                      formControlName="propertyId"
                      [options]="propertyOptions"
                      placeholder="Select property"
                      [allowEmpty]="false">
                    </app-custom-select>
                  </div>
                  <label class="relative inline-flex items-center h-7 w-14 cursor-pointer rounded-full border border-gray-200 bg-white shadow-sm">
                    <input type="checkbox" formControlName="isRequired" class="sr-only peer">
                    <span class="absolute inset-0 rounded-full bg-gray-200 peer-checked:bg-[#0a84ff] transition"></span>
                    <span class="absolute left-1 top-1 h-5 w-5 rounded-full bg-white shadow peer-checked:translate-x-7 transition"></span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="flex justify-center pt-2">
            <button type="button" (click)="addPropertyRow()"
              class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold text-white bg-[#0a84ff] shadow-sm hover:bg-[#006edc] active:bg-[#005bb5] transition">
              <span class="text-base leading-none">＋</span>
              Add property
            </button>
          </div>
        </div>

        <div class="flex items-center justify-between gap-3 pt-2">
          <div class="text-sm text-red-600" *ngIf="shouldShowClientError">
            Please enter a type name and select a property for every row.
          </div>
          <div class="text-sm text-red-600" *ngIf="serverError">{{ serverError }}</div>
          <div class="flex gap-3 ml-auto">
          <button type="button" *ngIf="dialogRef" (click)="dialogRef.close()"
            class="px-4 py-2 rounded-lg border border-gray-300 text-sm text-gray-700 hover:bg-gray-50">Cancel</button>
          <button type="submit"
            class="px-4 py-2 rounded-lg bg-[#007aff] text-white text-sm font-medium hover:bg-[#0061d5] transition disabled:bg-gray-300"
            [disabled]="!canSubmit">Save</button>
          </div>
        </div>
      </form>
    </div>
  </div>