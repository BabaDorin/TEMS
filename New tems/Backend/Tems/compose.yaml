services:
  mongodb:
    image: mongo:7.0
    container_name: tems-mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: TemsDb
    volumes:
      - mongodb_data:/data/db
    networks:
      - tems-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: tems-keycloak
    command: start-dev
    ports:
      - "8080:8080"
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KC_HTTP_PORT=8080
      - KC_HOSTNAME_STRICT=false
      - KC_HOSTNAME_STRICT_HTTPS=false
      - KC_HTTP_ENABLED=true
      - KC_HEALTH_ENABLED=true
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - tems-network

  identity-server:
    build:
      context: .
      dockerfile: Tems.IdentityServer/Dockerfile
    container_name: tems-identity-server
    ports:
      - "5001:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - MongoDb__ConnectionString=mongodb://mongodb:27017
      - MongoDb__DatabaseName=TemsDb
      - Duende__LicenseKey=eyJhbGciOiJQUzI1NiIsImtpZCI6IklkZW50aXR5U2VydmVyTGljZW5zZUtleS83Y2VhZGJiNzgxMzA0NjllODgwNjg5MTAyNTQxNGYxNiIsInR5cCI6ImxpY2Vuc2Urand0In0.eyJpc3MiOiJodHRwczovL2R1ZW5kZXNvZnR3YXJlLmNvbSIsImF1ZCI6IklkZW50aXR5U2VydmVyIiwiaWF0IjoxNzYzNTgyMTY2LCJleHAiOjE3OTUxMTgxNjYsImNvbXBhbnlfbmFtZSI6IkRvcmluIEJhYmEgLSBJbmRpdmlkdWFsIiwiY29udGFjdF9pbmZvIjoiZGV2LmRvcmluLmJhYmFAZ21haWwuY29tIiwiZWRpdGlvbiI6IkNvbW11bml0eSJ9.mg87g0hw2qSqFZSkXNxNgHEfOoBXV2aFJA-6xoNq-LavAeWYemsmf4Flw2_y5PBAp1uskPi_rTXAd7ArURFvDLBawZQMaxn-sk_lnpN0QfNPXs4Q6sjM3tdzRSF_hhJ22onpS0gKn8zBPdOMp7Qolex3h8YZEJkygoRrih0KIPTw66reQKPPN9Ff4bk85ZKiDUSkSmGNd0LtT0OEO9N4xmJ4qPCjBm4QR5KrEZUDDkhU71g5kDnPEmtA471GsqaqXBjTQnx7PzwMvtq03IAon2CoaN36y8KTkuVpQiBF6y6W3_dV0xLIpfFH5ORMtmaSsq8mt-LEZm_c7u1XY4-jlQ
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - tems-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/.well-known/openid-configuration || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    volumes:
      - identity-keys:/app/keys

networks:
  tems-network:
    driver: bridge

volumes:
  mongodb_data:
    driver: local
  identity-keys:
    driver: local

