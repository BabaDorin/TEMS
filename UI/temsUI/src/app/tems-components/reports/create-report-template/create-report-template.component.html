<div class="card">
  <div class="card-body">
    <h2>
      {{ 'report.createTemplate' | translate }}
    </h2>
    <hr class="mb-2">
    <form [formGroup]="reportFormGroup">
      <p class="text-muted">
        {{ 'report.createTemplateTip' | translate }}
      </p>
      
      <mat-form-field class="reportFormControl mb-2 d-block">
        <mat-label>{{ 'report.name' | translate }}</mat-label>
        <input matInput formControlName="name">
      </mat-form-field>

      <mat-form-field class="reportFormControl mb-2">
        <mat-label>{{ 'form.description' | translate }}</mat-label>
        <textarea matInput formControlName="description"></textarea>
      </mat-form-field>
      <hr class="mt-3 mb-3">

      <mat-vertical-stepper>
        <!-- STEP 1- Subject choice -->
        <mat-step>
          <ng-template matStepLabel>{{ 'report.selectSubject' | translate }}</ng-template>
          <p class="text-muted">
            {{ 'report.selectSubjectTip' | translate }}
          </p>
          <mat-form-field class="reportFormControl">
            <mat-label>{{ 'report.selectSubject' | translate }}</mat-label>
            <mat-select formControlName="subject">
              <mat-option *ngFor="let option of reportObjectOptions" [value]="option.value">
                {{ option.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <button mat-button class="d-block" matStepperNext>{{ 'general.next' | translate }}</button>
        </mat-step>

        <!-- STEP 2 - Layout configuration (For equipment: Types, definitions, personnel, room, SeparateBy) -->
        <mat-step>
          <ng-template matStepLabel>
            {{ 'report.layoutConfiguration' | translate }}
          </ng-template>
          <p class="text-muted">
            {{ 'report.layoutConfigurationTip' | translate }}
          </p>
          <ng-container *ngIf="reportFormGroup.controls.subject.value != 'equipment'">
            <p class="text-muted">
              {{ 'report.noSubjectSelected' | translate }}
            </p>
          </ng-container>
          <ng-container *ngIf="reportFormGroup.controls.subject.value == 'equipment'">
            <div class="row">
              <div class="col-md-5">
                <app-chips-autocomplete [label]="translate.instant('report.types')" formControlName="types"
                  [placeholder]="translate.instant('report.noSelection')" 
                  [alreadySelected]="typesAlreadySelected"s
                  [endPoint]="typeService"
                  (dataCollected)="typeAdded($event)"
                  (dataRemoved)="typeRemoved($event)">
                </app-chips-autocomplete>
              </div>
              <div class="col-md-5">
                <app-chips-autocomplete [label]="translate.instant('report.definitions')" formControlName="definitions"
                  [placeholder]="translate.instant('report.noSelection')" 
                  [endPoint]="definitionService"
                  [endPointParameter]="typesEndPointParameter"
                  [alreadySelected]="definitionsAlreadySelected">
                </app-chips-autocomplete>
              </div>
            </div>
            <br>
            <div class="row">
              <div class="col-md-5">
                <app-chips-autocomplete [label]="translate.instant('report.roomsFilter')" formControlName="rooms"
                  [placeholder]="translate.instant('report.noSelection')" 
                  [endPoint]="roomService" 
                  [alreadySelected]="roomsAlreadySelected">
                </app-chips-autocomplete>
              </div>
              <div class="col-md-5">
                <app-chips-autocomplete [label]="translate.instant('report.personnelFilter')"
                  formControlName="personnel" placeholder="No selection = all personnel"
                  [endPoint]="personnelService"
                  [alreadySelected]="personnelAlreadySelected">
                </app-chips-autocomplete>
              </div>
            </div>
            <br>
            <mat-label>{{ 'report.separateBy' | translate }}</mat-label><br><br>
            
            <mat-radio-group formControlName="separateBy">
              <mat-radio-button value="none">{{ 'report.noSeparation' | translate }}</mat-radio-button><br>
              <mat-radio-button value="room">{{ 'report.byRoom' | translate }}</mat-radio-button><br>
              <mat-radio-button value="personnel">{{ 'report.byPersonnel | translate }}</mat-radio-button><br>
              <mat-radio-button value="type">{{ 'report.bytType' | translate }}</mat-radio-button><br>
              <mat-radio-button value="definition">{{ 'report.byDefinition' | translate }}</mat-radio-button><br>
            </mat-radio-group>
          </ng-container>
          <button mat-button matStepperNext>{{ 'general.next' | translate }}</button>
        </mat-step>

        <!-- STEP - Select report properties -->
        <mat-step>
          <ng-template matStepLabel>{{ 'report.selectColumns' | translate }}</ng-template>

          <!-- No subject selected -->
          <ng-container *ngIf="reportFormGroup.controls.subject.value != 'equipment'">
            <p class="text-muted">{{ 'report.noSubjectSelected' | translate }}</p>
          </ng-container>

          <!-- Equipment subject -->
          <ng-container *ngIf="reportFormGroup.controls.subject.value == 'equipment'">
            <!-- Common properties for all equipment records -->
            <app-checkbox-group [options]="equipmentCommonProperties"[label]="translate.instant('report.commonProperties')"
            (toggle)="onCommonPropChange($event)">
            </app-checkbox-group>

            <!-- Type specific properties -->
            <ng-container *ngFor="let type of typeSpecificProperties">
            <div class="mt-2">
              <app-checkbox-group [options]="type.properties" [label]="translate.instant('report.specificProperties') + type.type.label"
              (toggle)="onSpecificPropChange($event, type.type)">
              </app-checkbox-group>
            </div>
            </ng-container>
          </ng-container>
          <button mat-button matStepperNext>{{ 'general.next' | translate }}</button>
        </mat-step>

        <mat-step>
          <ng-template matStepLabel>{{ 'report.additional' | translate }}</ng-template>
          <br>
          <mat-form-field class="reportFormControl d-block">
            <mat-label>{{ 'report.header' | translate }}</mat-label>
            <textarea matInput formControlName="header"></textarea>
          </mat-form-field>
          <mat-form-field class="reportFormControl d-block">
            <mat-label>{{ 'report.footer' | translate }}</mat-label>
            <textarea matInput formControlName="footer"></textarea>
          </mat-form-field>
          <!-- signatories   -->
          <app-chips-autocomplete
          class="reportFormControl d-block"
          [label]="translate.instant('report.signatories')"
          formControlName="signatories"
          [alreadySelected]="signatoriesAlreadySelected"
          [endPoint]="personnelService"
          onlyValuesFromAutocomplete="true">
          </app-chips-autocomplete>
        </mat-step>
      </mat-vertical-stepper>
      <button mat-button (click)="save()" class="d-block">
        <mat-icon class="text-primary">save</mat-icon>
        {{ 'report.save' | translate }}
      </button>
      <button mat-button (click)="generateReport()" class="d-block">
        <mat-icon class="text-primary">print</mat-icon>
        {{ 'report.generate' | translate }}
      </button>
    </form>
  </div>
</div>