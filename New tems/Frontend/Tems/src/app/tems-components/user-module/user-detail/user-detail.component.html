<div class="min-h-screen bg-gray-50/50 dark:bg-[#1c1c1e] transition-colors duration-200">
  <!-- Loading State -->
  <div *ngIf="loading" class="flex items-center justify-center h-screen">
    <div class="text-center">
      <svg class="animate-spin h-10 w-10 text-[#007aff] dark:text-[#0a84ff] mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p class="mt-3 text-sm text-gray-600 dark:text-gray-400">Loading user details...</p>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="!loading && error" class="flex items-center justify-center h-screen">
    <div class="text-center">
      <svg class="h-12 w-12 text-red-500 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <p class="mt-3 text-sm text-gray-900 dark:text-white font-medium">{{ error }}</p>
      <button
        (click)="goBack()"
        class="mt-4 px-4 py-2 bg-[#007aff] text-white text-sm rounded-lg hover:bg-[#0051d5] transition">
        Back to Users
      </button>
    </div>
  </div>

  <!-- User Detail -->
  <div *ngIf="!loading && !error && user" class="max-w-5xl mx-auto p-4 sm:p-6">
    <!-- Back Button -->
    <button
      (click)="goBack()"
      class="mb-4 text-sm text-[#007aff] dark:text-[#0a84ff] hover:text-[#0051d5] flex items-center gap-1.5 transition">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
        <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Back to Users
    </button>

    <!-- Header Card -->
    <div class="bg-white dark:bg-[#2c2c2e] rounded-xl shadow-sm mb-4">
      <div class="px-6 py-4">
        <div class="flex justify-between items-start">
          <div class="flex items-center gap-4">
            <!-- User Avatar -->
            <div class="w-16 h-16 flex-shrink-0">
              <svg width="64" height="64" viewBox="0 0 80 80" fill="none">
                <defs>
                  <linearGradient id="userGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="#00d4ff"/>
                    <stop offset="50%" stop-color="#0a84ff"/>
                    <stop offset="100%" stop-color="#5e5ce6"/>
                  </linearGradient>
                </defs>
                <path d="M 40 4 L 68 20 L 68 52 L 40 68 L 12 52 L 12 20 Z" fill="url(#userGradient)" opacity="0.9"/>
                <g transform="translate(40, 36)">
                  <circle cx="0" cy="-6" r="8" fill="#ffffff" opacity="0.9"/>
                  <path d="M -10 10 L -6 2 L 6 2 L 10 10 Z" fill="#ffffff" opacity="0.9"/>
                </g>
              </svg>
            </div>
            <div>
              <h1 class="text-2xl font-semibold text-gray-900 dark:text-white m-0">{{ getUserFullName() }}</h1>
              <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 m-0">{{ user.email }}</p>
              <!-- Roles -->
              <div class="flex flex-wrap gap-1 mt-2">
                <span 
                  *ngFor="let role of user.roles" 
                  class="px-2 py-0.5 text-xs rounded-full bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300 font-medium">
                  {{ role }}
                </span>
              </div>
            </div>
          </div>
          
          <!-- Actions Dropdown -->
          <div class="relative actions-dropdown ml-4">
            <button
              (click)="showActionsDropdown = !showActionsDropdown"
              class="px-3 py-1.5 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-white/10 rounded-lg transition flex items-center gap-1.5 border border-gray-300 dark:border-[#48484a]">
              <span>Actions</span>
              <svg width="14" height="14" viewBox="0 0 16 16" fill="none" class="transition-transform" [class.rotate-180]="showActionsDropdown">
                <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div 
              *ngIf="showActionsDropdown"
              class="absolute right-0 mt-2 w-48 bg-white dark:bg-[#2c2c2e] rounded-lg shadow-lg border border-gray-200 dark:border-[#38383a] py-1 z-10">
              <button
                (click)="editUserRoles(); showActionsDropdown = false"
                class="w-full px-4 py-2 text-left text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-white/5 flex items-center gap-2">
                <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
                  <path d="M11.3337 2.00004C11.5089 1.82494 11.7169 1.68605 11.9457 1.59129C12.1745 1.49653 12.4197 1.44775 12.667 1.44775C12.9144 1.44775 13.1596 1.49653 13.3884 1.59129C13.6172 1.68605 13.8252 1.82494 14.0003 2.00004C14.1754 2.17513 14.3143 2.38311 14.4091 2.61195C14.5038 2.84079 14.5526 3.08595 14.5526 3.33337C14.5526 3.58079 14.5038 3.82595 14.4091 4.05479C14.3143 4.28363 14.1754 4.49161 14.0003 4.66671L5.00033 13.6667L1.33366 14.6667L2.33366 11L11.3337 2.00004Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Edit Roles
              </button>
              <button
                (click)="deleteUser(); showActionsDropdown = false"
                class="w-full px-4 py-2 text-left text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-500/10 flex items-center gap-2">
                <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
                  <path d="M2 4H14M5.333 4V2.667C5.333 2.313 5.474 1.974 5.724 1.724C5.974 1.474 6.313 1.333 6.667 1.333H9.333C9.687 1.333 10.026 1.474 10.276 1.724C10.526 1.974 10.667 2.313 10.667 2.667V4M12.667 4V13.333C12.667 13.687 12.526 14.026 12.276 14.276C12.026 14.526 11.687 14.667 11.333 14.667H4.667C4.313 14.667 3.974 14.526 3.724 14.276C3.474 14.026 3.333 13.687 3.333 13.333V4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Delete User
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white dark:bg-[#2c2c2e] rounded-xl shadow-sm">
      <div>
        <nav class="flex px-4 overflow-x-auto border-b border-gray-200 dark:border-[#38383a]">
          <button
            (click)="activeTab = 'overview'"
            [class.border-[#007aff]]="activeTab === 'overview'"
            [class.text-[#007aff]]="activeTab === 'overview'"
            [class.border-transparent]="activeTab !== 'overview'"
            [class.text-gray-500]="activeTab !== 'overview'"
            class="px-4 py-3 border-b-2 font-medium text-sm hover:text-[#007aff] transition whitespace-nowrap">
            Overview
          </button>
          <button
            (click)="selectTab('assets')"
            [class.border-[#007aff]]="activeTab === 'assets'"
            [class.text-[#007aff]]="activeTab === 'assets'"
            [class.border-transparent]="activeTab !== 'assets'"
            [class.text-gray-500]="activeTab !== 'assets'"
            class="px-4 py-3 border-b-2 font-medium text-sm hover:text-[#007aff] transition whitespace-nowrap">
            Assets
          </button>
          <button
            disabled
            class="px-4 py-3 border-b-2 border-transparent text-gray-400 dark:text-gray-500 text-sm cursor-not-allowed whitespace-nowrap">
            Allocations
          </button>
        </nav>
      </div>

      <!-- Tab Content -->
      <div class="p-6">
        <!-- Overview Tab -->
        <div *ngIf="activeTab === 'overview'" class="space-y-4">
          <!-- Basic Information Grid -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div>
              <span class="text-xs text-gray-600 dark:text-gray-400 uppercase tracking-wide">Username</span>
              <p class="text-sm font-medium text-gray-900 dark:text-white mt-1 mb-0">{{ user.username }}</p>
            </div>
            <div>
              <span class="text-xs text-gray-600 dark:text-gray-400 uppercase tracking-wide">Email</span>
              <p class="text-sm font-medium text-gray-900 dark:text-white mt-1 mb-0">{{ user.email }}</p>
            </div>
            <div>
              <span class="text-xs text-gray-600 dark:text-gray-400 uppercase tracking-wide">First Name</span>
              <p class="text-sm font-medium text-gray-900 dark:text-white mt-1 mb-0">{{ user.firstName || '—' }}</p>
            </div>
            <div>
              <span class="text-xs text-gray-600 dark:text-gray-400 uppercase tracking-wide">Last Name</span>
              <p class="text-sm font-medium text-gray-900 dark:text-white mt-1 mb-0">{{ user.lastName || '—' }}</p>
            </div>
            <div>
              <span class="text-xs text-gray-600 dark:text-gray-400 uppercase tracking-wide">Created</span>
              <p class="text-sm font-medium text-gray-900 dark:text-white mt-1 mb-0">{{ formatDate(user.createdAt) }}</p>
            </div>
            <div>
              <span class="text-xs text-gray-600 dark:text-gray-400 uppercase tracking-wide">Updated</span>
              <p class="text-sm font-medium text-gray-900 dark:text-white mt-1 mb-0">{{ formatDate(user.updatedAt) }}</p>
            </div>
          </div>

          <!-- Tenants -->
          <div class="bg-white dark:bg-[#3a3a3c] rounded-xl border border-gray-200 dark:border-[#48484a]">
            <div class="px-4 py-3 border-b border-gray-100 dark:border-[#48484a]">
              <h3 class="text-sm font-semibold text-gray-900 dark:text-white m-0">Tenants</h3>
            </div>
            <div class="p-4">
              <div class="flex flex-wrap gap-2">
                <span 
                  *ngFor="let tenant of user.tenantIds" 
                  class="px-3 py-1.5 text-sm rounded-lg bg-[#007aff]/10 text-[#007aff] dark:bg-[#0a84ff]/20 dark:text-[#0a84ff] font-medium">
                  {{ tenant }}
                </span>
                <span *ngIf="!user.tenantIds?.length" class="text-sm text-gray-400 dark:text-gray-500">No tenants assigned</span>
              </div>
            </div>
          </div>

          <!-- Roles -->
          <div class="bg-white dark:bg-[#3a3a3c] rounded-xl border border-gray-200 dark:border-[#48484a]">
            <div class="px-4 py-3 border-b border-gray-100 dark:border-[#48484a]">
              <h3 class="text-sm font-semibold text-gray-900 dark:text-white m-0">Roles</h3>
            </div>
            <div class="p-4">
              <div class="flex flex-wrap gap-2">
                <span 
                  *ngFor="let role of user.roles" 
                  class="px-3 py-1.5 text-sm rounded-lg bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300 font-medium">
                  {{ role }}
                </span>
                <span *ngIf="!user.roles?.length" class="text-sm text-gray-400 dark:text-gray-500">No roles assigned</span>
              </div>
            </div>
          </div>

          <!-- Keycloak ID -->
          <div *ngIf="user.keycloakId" class="bg-white dark:bg-[#3a3a3c] rounded-xl border border-gray-200 dark:border-[#48484a]">
            <div class="px-4 py-3 border-b border-gray-100 dark:border-[#48484a]">
              <h3 class="text-sm font-semibold text-gray-900 dark:text-white m-0">Keycloak ID</h3>
            </div>
            <div class="p-4">
              <p class="text-sm text-gray-700 dark:text-gray-300 font-mono break-all m-0">{{ user.keycloakId }}</p>
            </div>
          </div>
        </div>

        <!-- Assets Tab -->
        <div *ngIf="activeTab === 'assets'">
          <!-- Toolbar -->
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
              <button
                (click)="openAllocateAssetModal()"
                class="px-4 py-2 bg-[#007aff] text-white text-sm font-medium rounded-lg hover:bg-[#0051d5] transition flex items-center gap-2">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M8 3V13M3 8H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Allocate Asset
              </button>
              <button
                *ngIf="selectedAssets.length > 0"
                (click)="unassignSelected()"
                class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition flex items-center gap-2">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M11 5L5 11M5 5L11 11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                Unassign ({{ selectedAssets.length }})
              </button>
            </div>
            <span class="text-sm text-gray-500 dark:text-gray-400">
              {{ assetsTotalCount }} asset{{ assetsTotalCount !== 1 ? 's' : '' }}
            </span>
          </div>

          <!-- Filters -->
          <div class="bg-white dark:bg-[#3a3a3c] rounded-xl border border-gray-200 dark:border-[#48484a] mb-4 transition-all duration-300">
            <!-- Filter Header -->
            <div 
              (click)="toggleFilters()"
              class="px-4 py-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-white/5 transition flex items-center justify-between">
              <div class="flex items-center gap-2 flex-1">
                <div class="w-8 h-8 rounded-full bg-[#007aff]/10 flex items-center justify-center flex-shrink-0">
                  <svg width="18" height="18" viewBox="0 0 20 20" fill="none" class="text-[#007aff]">
                    <path d="M2.5 5.83333H17.5M5.83333 10H14.1667M8.33333 14.1667H11.6667" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
                <div class="self-center">
                  <h3 class="text-sm font-medium text-gray-900 dark:text-white leading-tight m-0">Filters</h3>
                  <p class="text-xs text-gray-500 dark:text-gray-400 leading-tight m-0">
                    <span *ngIf="getActiveFilterCount() === 0">No filters applied</span>
                    <span *ngIf="getActiveFilterCount() > 0">{{ getActiveFilterCount() }} filter(s) active</span>
                  </p>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button
                  *ngIf="getActiveFilterCount() > 0 && !isFiltersExpanded"
                  (click)="clearFilters(); $event.stopPropagation()"
                  class="text-sm text-[#007aff] hover:text-[#0051d5] transition">
                  Clear All Filters
                </button>
                <button class="p-1.5 hover:bg-gray-100 dark:hover:bg-white/10 rounded-lg transition">
                  <svg width="18" height="18" viewBox="0 0 20 20" fill="none" class="text-gray-600 dark:text-gray-400 transition-transform" [class.rotate-180]="isFiltersExpanded">
                    <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </div>

            <!-- Filter Content -->
            <div *ngIf="isFiltersExpanded" @expandCollapse class="border-t border-gray-200 dark:border-[#48484a]">
              <div class="p-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <!-- Asset Tag Search -->
                  <div>
                    <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1.5">Asset Tag</label>
                    <input
                      type="text"
                      [(ngModel)]="assetTagSearch"
                      (ngModelChange)="onAssetTagChange()"
                      placeholder="Search by asset tag..."
                      class="w-full px-3 py-2 border border-gray-200 dark:border-[#48484a] dark:bg-[#2c2c2e] dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-[#007aff] text-sm">
                  </div>

                  <!-- Type Filter -->
                  <div>
                    <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1.5">Asset Type</label>
                    <app-custom-select
                      [options]="typeOptions"
                      [placeholder]="'Select types...'"
                      [mode]="'multiple'"
                      [allowEmpty]="true"
                      [ngModel]="selectedTypeIds"
                      (ngModelChange)="onTypeSelectionChange($event)">
                    </app-custom-select>
                  </div>

                  <!-- Definition Filter -->
                  <div>
                    <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1.5">Definition</label>
                    <app-custom-select
                      [options]="definitionOptions"
                      [placeholder]="selectedTypeIds.length === 0 ? 'Select type first' : 'Select definitions...'"
                      [mode]="'multiple'"
                      [disabled]="selectedTypeIds.length === 0"
                      [allowEmpty]="true"
                      [ngModel]="selectedDefinitionIds"
                      (ngModelChange)="onDefinitionSelectionChange($event)">
                    </app-custom-select>
                  </div>
                </div>

                <!-- Clear Filters Button -->
                <div *ngIf="getActiveFilterCount() > 0" class="mt-4 flex justify-end">
                  <button
                    (click)="clearFilters()"
                    class="text-sm text-[#007aff] hover:text-[#0051d5] transition">
                    Clear All Filters
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Assets Grid -->
          <div *ngIf="assetsLoading" class="flex items-center justify-center py-12">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#007aff]"></div>
          </div>

          <div *ngIf="!assetsLoading && filteredAssets.length === 0" class="text-center py-12">
            <svg class="h-12 w-12 text-gray-300 dark:text-gray-600 mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
            <p class="text-sm text-gray-500 dark:text-gray-400">No assets assigned to this user</p>
            <button
              (click)="openAllocateAssetModal()"
              class="mt-3 px-4 py-2 text-sm text-[#007aff] hover:bg-[#007aff]/5 rounded-lg transition">
              Allocate an asset
            </button>
          </div>

          <div *ngIf="!assetsLoading && filteredAssets.length > 0" class="rounded-lg overflow-hidden border border-gray-200 dark:border-[#48484a]">
            <ag-grid-angular
              [ngClass]="gridThemeClass"
              style="height: 400px; width: 100%;"
              [rowData]="filteredAssets"
              [columnDefs]="assetsColumnDefs"
              [rowSelection]="'multiple'"
              [suppressRowClickSelection]="true"
              (gridReady)="onAssetsGridReady($event)"
              (selectionChanged)="onSelectionChanged()">
            </ag-grid-angular>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Asset Preview Modal -->
  <div *ngIf="showPreviewModal && selectedAssetForPreview" 
    class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
    (click)="closePreviewModal()">
    <div class="bg-white dark:bg-[#2c2c2e] rounded-xl max-w-lg w-full mx-4 overflow-hidden"
      (click)="$event.stopPropagation()">
      <!-- Header -->
      <div class="px-6 py-4 border-b border-gray-200 dark:border-[#38383a] flex items-center justify-between">
        <div>
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white m-0">{{ selectedAssetForPreview.assetTag }}</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400 m-0">{{ selectedAssetForPreview.definition?.assetTypeName }}</p>
        </div>
        <button (click)="closePreviewModal()" class="p-2 hover:bg-gray-100 dark:hover:bg-white/10 rounded-lg transition">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" class="text-gray-500">
            <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <!-- Content -->
      <div class="p-6 max-h-96 overflow-y-auto">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Serial Number</span>
            <p class="text-sm font-medium text-gray-900 dark:text-white mt-1 m-0">{{ selectedAssetForPreview.serialNumber || '—' }}</p>
          </div>
          <div>
            <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Status</span>
            <p class="text-sm font-medium text-gray-900 dark:text-white mt-1 m-0">{{ formatStatus(selectedAssetForPreview.status) }}</p>
          </div>
          <div>
            <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Definition</span>
            <p class="text-sm font-medium text-gray-900 dark:text-white mt-1 m-0">{{ selectedAssetForPreview.definition?.name || '—' }}</p>
          </div>
          <div>
            <span class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Manufacturer</span>
            <p class="text-sm font-medium text-gray-900 dark:text-white mt-1 m-0">{{ selectedAssetForPreview.definition?.manufacturer || '—' }}</p>
          </div>
        </div>
      </div>

      <!-- See More Button -->
      <div class="mt-6 flex justify-center">
        <button
          (click)="navigateToAssetDetail(selectedAssetForPreview.id)"
          class="px-2.5 py-1.5 text-xs text-gray-500 dark:text-gray-400 hover:text-[#007aff] hover:bg-[#007aff]/5 rounded-lg transition flex items-center gap-1.5">
          <svg width="12" height="12" viewBox="0 0 16 16" fill="none">
            <path d="M6 2H3C2.44772 2 2 2.44772 2 3V13C2 13.5523 2.44772 14 3 14H13C13.5523 14 14 13.5523 14 13V10M9 2H14M14 2V7M14 2L7 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>See More Details</span>
        </button>
      </div>
    </div>
  </div>
</div>
